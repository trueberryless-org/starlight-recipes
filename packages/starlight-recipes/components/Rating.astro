---
import context from "virtual:starlight-recipes-context";

interface Props {
  recipeId: string;
}

const { recipeId } = Astro.props;
---

<recipe-rating
  data-recipe-id={recipeId}
  data-interactive={context.ratingEnabled ? "true" : "false"}
  class="not-content"
  style="margin: 0"
>
  <div class="rating-wrapper">
    <div class="rating-container" id="main-container">
      <div class="stars-wrapper" id="stars-container">
        {
          [5, 4, 3, 2, 1].map((num) => (
            <button
              type="button"
              class="star-btn"
              data-value={num}
              aria-label={`Rate ${num} stars`}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="star-icon"
              >
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
              </svg>
            </button>
          ))
        }
      </div>

      <div class="rating-stats">
        <div class="loading-spinner" id="spinner"></div>
        <span class="avg-value">...</span>
        <span class="count-value"></span>
      </div>
    </div>
    <div class="error-msg" id="error-display">Already voted!</div>
  </div>
</recipe-rating>

<script>
  class RecipeRating extends HTMLElement {
    constructor() {
      super();
      const recipeId = this.dataset.recipeId;
      const isInteractive = this.dataset.interactive === "true";
      const votedKey = `sl-recipes-voted-${recipeId}`;

      this.refreshStats();
      this.checkVoted(votedKey);

      if (!isInteractive) return;

      const buttons = this.querySelectorAll(".star-btn");
      buttons.forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (localStorage.getItem(votedKey)) {
            this.showError();
            return;
          }

          this.setLoading(true);

          const stars = btn.getAttribute("data-value");
          try {
            const res = await fetch("/api/recipe/rate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ recipeId, stars: parseInt(stars!) }),
            });

            if (res.ok) {
              const updatedData = await res.json();
              localStorage.setItem(votedKey, "true");
              this.checkVoted(votedKey);
              this.updateUI(updatedData.ratingValue, updatedData.ratingCount);
            } else if (res.status === 403) {
              localStorage.setItem(votedKey, "true");
              this.checkVoted(votedKey);
              this.showError();
            }
          } catch (e) {
            console.error("Voting failed", e);
          } finally {
            this.setLoading(false);
          }
        });
      });
    }

    showError() {
      const container = this.querySelector(".rating-container");
      const errorMsg = this.querySelector("#error-display");
      container?.classList.add("shake-error");
      errorMsg?.classList.add("visible");
      setTimeout(() => {
        container?.classList.remove("shake-error");
        errorMsg?.classList.remove("visible");
      }, 2000);
    }

    setLoading(isLoading: boolean) {
      const container = this.querySelector(".rating-container");
      if (isLoading) {
        container?.classList.add("is-loading");
      } else {
        container?.classList.remove("is-loading");
      }
    }

    checkVoted(key: string) {
      const isInteractive = this.dataset.interactive === "true";
      if (localStorage.getItem(key) || !isInteractive) {
        this.querySelector(".rating-container")?.classList.add("is-voted");
      }
    }

    highlightStars(rating: number) {
      this.querySelectorAll(".star-btn").forEach((btn) =>
        btn.classList.remove("selected")
      );
      const roundedRating = Math.round(rating);
      if (roundedRating > 0) {
        const starToSelect = this.querySelector(
          `.star-btn[data-value="${roundedRating}"]`
        );
        starToSelect?.classList.add("selected");
      }
    }

    updateUI(avg: number, count: number) {
      const avgEl = this.querySelector(".avg-value");
      const countEl = this.querySelector(".count-value");
      const recipeId = this.dataset.recipeId;
      const votedKey = `sl-recipes-voted-${recipeId}`;
      const isInteractive = this.dataset.interactive === "true";

      if (avgEl) {
        avgEl.textContent = avg > 0 ? Number(avg).toFixed(1) : "No ratings";
      }
      if (countEl) countEl.textContent = `(${count})`;

      if (localStorage.getItem(votedKey) || !isInteractive) {
        this.highlightStars(avg);
      }
    }

    async refreshStats() {
      const recipeId = this.dataset.recipeId;
      const spinner = this.querySelector("#spinner");
      spinner?.classList.add("active");

      try {
        const res = await fetch(`/api/recipe/get-rating?id=${recipeId}`);
        const data = await res.json();
        this.updateUI(data.ratingValue, data.ratingCount);
      } catch (e) {
        console.error("Could not fetch ratings");
      } finally {
        spinner?.classList.remove("active");
      }
    }
  }

  customElements.define("recipe-rating", RecipeRating);
</script>

<style>
  .rating-wrapper {
    position: relative;
    display: inline-flex;
    flex-direction: column;
    align-items: center;
  }

  .rating-container {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: var(--sl-color-gray-6, #1e293b);
    border-radius: 99px;
    border: 1px solid var(--sl-color-gray-5);
    transition: all 0.3s ease;
  }

  .error-msg {
    position: absolute;
    bottom: -1.5rem;
    font-size: 0.75rem;
    color: #ef4444;
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    white-space: nowrap;
  }

  .error-msg.visible {
    opacity: 1;
  }

  .shake-error {
    animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    border-color: #ef4444 !important;
  }

  @keyframes shake {
    10%,
    90% {
      transform: translate3d(-1px, 0, 0);
    }
    20%,
    80% {
      transform: translate3d(2px, 0, 0);
    }
    30%,
    50%,
    70% {
      transform: translate3d(-3px, 0, 0);
    }
    40%,
    60% {
      transform: translate3d(3px, 0, 0);
    }
  }

  .is-loading {
    pointer-events: none;
    opacity: 0.8;
  }

  .is-loading .star-icon {
    animation: star-pulse 1.5s infinite ease-in-out;
  }

  @keyframes star-pulse {
    0% {
      color: var(--sl-color-gray-4);
      transform: scale(1);
    }
    50% {
      color: #facc15;
      transform: scale(1.1);
    }
    100% {
      color: var(--sl-color-gray-4);
      transform: scale(1);
    }
  }

  .loading-spinner {
    display: none;
    width: 12px;
    height: 12px;
    border: 2px solid var(--sl-color-gray-4);
    border-top: 2px solid #facc15;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .loading-spinner.active {
    display: inline-block;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Greyed out state */
  .rating-container.is-voted {
    background: var(--sl-color-gray-6, #1e293b);
    opacity: 0.7;
    filter: grayscale(0.4);
    border-color: transparent;
  }

  .is-voted .star-btn {
    cursor: default;
    pointer-events: none;
  }

  .is-voted .avg-value,
  .is-voted .count-value {
    color: var(--sl-color-gray-3);
  }

  .stars-wrapper {
    display: flex;
    flex-direction: row-reverse;
    align-items: center;
  }

  .star-btn {
    background: none;
    border: none;
    padding: 0 1px;
    cursor: pointer;
    color: var(--sl-color-gray-4);
    transition:
      transform 0.1s ease,
      color 0.2s ease;
    display: flex;
    align-items: center;
  }

  .star-btn:hover {
    transform: scale(1.2);
  }

  .star-btn:hover,
  .star-btn:hover ~ .star-btn,
  .star-btn.selected,
  .star-btn.selected ~ .star-btn {
    color: #facc15;
  }

  .star-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  .rating-stats {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.9rem;
    line-height: 1;
  }

  .avg-value {
    font-weight: 700;
    color: var(--sl-color-white);
  }
  .count-value {
    color: var(--sl-color-gray-3);
  }
</style>
